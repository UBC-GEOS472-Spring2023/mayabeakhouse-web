<!DOCTYPE html>
<html>
  <head>
    <title>Leaflet Exercise</title>
    <meta charset="utf-8" />

    <!-- Leaflet styles and code. Place in the <head></head> element. -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    />
  </head>
  <body>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <!-- jQuery is a library that simplifies many things in JavaScript. 
	     We'll use it to retrieve data from the web. -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

    <script src="./p5.min.js"></script>
    <!-- this should be unnecessary in this code, as we aren't using p5.js... but since I'm showing you the code running in the p5 editor, the editor expects p5.js to be here... otherwise, it gives you a "TypeError: window.p5 is undefined". We won't use any of p5.js's commands, though! -->
    <!-- Load animation tweening library requirement for CanvasFlowMapLayer -->
    <script src="https://unpkg.com/@tweenjs/tween.js@18.5.0/dist/tween.umd.js"></script>

    <!-- Load CanvasFlowMapLayer; change the path (relative URL) if necessary -->
    <script src="CanvasFlowmapLayer.js"></script>

    <!-- also load 3rd-party CSV parsing libary just for this demo  -->
    <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>

    <div id="mapid" style="width: 1250px; height: 800px;"></div>
    <!-- Our web map will get placed into this div element -->

    <script>

        // Make a Leaflet map with L.map().
        // Store the map in the variable 'map'.
        // "mapid" is the 'id' of the DOM element to contain the map.
        var map = L.map('mapid',
                        {
          								center: [43.970583, -120.549005],
          								zoom: 7
        								}  // this object holds map options
                  );

      var CartoDB_DarkMatter = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
	attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
	subdomains: 'abcd',
	maxZoom: 20
})
.addTo(map);

Papa.parse('../csv-data.csv', {
      download: true,
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true,
      complete: function(results) {
        var geoJsonFeatureCollection = {
          type: 'FeatureCollection',
          features: results.data.map(function(datum) {
            return {
              type: 'Feature',
              geometry: {
                type: 'Point',
                coordinates: [datum.r_lon, datum.r_lat]
              },
              properties: datum
            }
          })
        };

        var oneToManyFlowmapLayer = L.canvasFlowmapLayer(geoJsonFeatureCollection, {
          originAndDestinationFieldIds: {
            originUniqueIdField: 'r_GEOID',
            originGeometry: {
              x: 'r_lon',
              y: 'r_lat'
            },
            destinationUniqueIdField: 'w_GEOID',
            destinationGeometry: {
              x: 'w_lon',
              y: 'w_lat'
            }
          },
          pathDisplayMode: 'selection',
          animationStarted: true,
          animationEasingFamily: 'Cubic',
          animationEasingType: 'In',
          animationDuration: 2000
        }).addTo(map);

        // since this demo is using the optional "pathDisplayMode" as "selection",
        // it is up to the developer to wire up a click or mouseover listener
        // and then call the "selectFeaturesForPathDisplay()" method to inform the layer
        // which Bezier paths need to be drawn
        oneToManyFlowmapLayer.on('click', function(e) {
          if (e.sharedOriginFeatures.length) {
            oneToManyFlowmapLayer.selectFeaturesForPathDisplay(e.sharedOriginFeatures, 'SELECTION_NEW');
          }
          if (e.sharedDestinationFeatures.length) {
            oneToManyFlowmapLayer.selectFeaturesForPathDisplay(e.sharedDestinationFeatures, 'SELECTION_NEW');
          }
        });

        // immediately select an origin point for Bezier path display,
        // instead of waiting for the first user click event to fire
        oneToManyFlowmapLayer.selectFeaturesForPathDisplayById('s_city_id', 562, true, 'SELECTION_NEW');
      }
    });
    </script>
  </body>
</html>
